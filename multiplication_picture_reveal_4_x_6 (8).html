<style>
:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#0f172a}
body{margin:18px;background:#f3f4f6}
h1{font-size:18px;margin:0 0 10px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
.tables{display:flex;gap:6px;flex-wrap:wrap}
.table-btn{border:1px solid #cbd5e1;background:white;padding:6px 8px;cursor:pointer}
.table-btn.on{background:#2563eb;color:white;border-color:#1d4ed8}
button.primary{background:#2563eb;color:white;border:none;padding:8px 10px;cursor:pointer}
button.ghost{background:transparent;border:1px solid #cbd5e1;padding:6px 8px;cursor:pointer}
.picture-controls{width:100%;margin-top:6px;display:flex;gap:8px;align-items:center}
.picture-controls input{flex:1;min-width:200px;padding:6px;border:1px solid #d1d5db}
.generate-link{margin-top:6px;display:flex;gap:8px;align-items:center}
.board-wrapper{width:100%;max-width:400px;margin:0 auto;position:relative;overflow:hidden;display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(4,1fr);gap:1px;aspect-ratio:6/4;}
#board-background{position:absolute;top:0;left:0;width:100%;height:100%;background-color:#e5e7eb;background-size:cover;background-position:center;background-repeat:no-repeat;z-index:0;}
.board{display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(4,1fr);gap:1px;width:100%;height:100%;position:absolute;top:0;left:0;z-index:1;}
.tile{background:white;color:#0f172a;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;user-select:none;transition:background-color 0.15s,border-color 0.15s;}
.tile.selected{background:#dbeafe;border:2px solid #2563eb}
.tile.matched{opacity:0;pointer-events:none;transition:opacity .4s}
.tile.incorrect{background:#fecaca !important;}
@media(max-width:839px){.board-wrapper{grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(6,1fr);max-width:300px;aspect-ratio:4/6;}.board{grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(6,1fr);}}
</style>

<h1>Multiplication Matching — Picture Reveal (4×6)</h1>
<div class="controls">
  <div>
    <div class="small">Left multiplicand:</div>
    <div class="tables" id="leftTables"></div>
    <div class="small" style="margin-top:4px;">Right multiplicand:</div>
    <div class="tables" id="rightTables"></div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
    <button class="primary" id="goBtn">Start / Reset</button>
    <button class="ghost" id="reshuffleBtn">Reshuffle</button>
  </div>
</div>
<div class="picture-controls">
  <div class="small">Hidden picture URL:</div>
  <input id="picURL" placeholder="https://example.com/image.jpg" />
  <button class="ghost" id="applyPicBtn">Apply Picture</button>
</div>
<div class="generate-link">
  <button class="ghost" id="generateLinkBtn">Generate Link</button>
  <input type="text" id="generatedLink" readonly style="flex:1;padding:4px;border:1px solid #d1d5db" />
</div>
<div class="board-wrapper">
  <div id="board-background"></div>
  <div id="board" class="board" aria-live="polite"></div>
</div>

<script>
(function(){
  const leftRoot = document.getElementById('leftTables');
  const rightRoot = document.getElementById('rightTables');
  const boardEl = document.getElementById('board');
  const bgEl = document.getElementById('board-background');
  const goBtn = document.getElementById('goBtn');
  const reshuffleBtn = document.getElementById('reshuffleBtn');
  const picURLInput = document.getElementById('picURL');
  const applyPicBtn = document.getElementById('applyPicBtn');
  const generateLinkBtn = document.getElementById('generateLinkBtn');
  const generatedLinkInput = document.getElementById('generatedLink');

  let leftTables = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
  let rightTables = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
  const tilesCount = 24;
  let tiles = [];
  let selected = [];

  function makeTableButtons(root,set){
    for(let i=1;i<=12;i++){
      const btn=document.createElement('button');
      btn.className=set.has(i)?'table-btn on':'table-btn';
      btn.textContent=i;
      btn.addEventListener('click',()=>{
        if(set.has(i)) set.delete(i); else set.add(i);
        btn.classList.toggle('on');
      });
      root.appendChild(btn);
    }
  }

  function generatePairs(){
    const possible=[];
    for(const l of leftTables){ for(const r of rightTables){ possible.push({l,r,p:l*r}); }}
    for(let i=possible.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[possible[i],possible[j]]=[possible[j],possible[i]];}
    return possible.slice(0, tilesCount/2);
  }

  function buildBoard(){
    boardEl.innerHTML='';
    tiles=[]; selected=[];
    const pairs=generatePairs();
    pairs.forEach((p,id)=>{
      tiles.push({id, typ:'expr', text:`${p.l}×${p.r}`, val:p.p, matched:false});
      tiles.push({id, typ:'prod', text:`${p.p}`, val:p.p, matched:false});
    });
    for(let i=tiles.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[tiles[i],tiles[j]]=[tiles[j],tiles[i]];}
    tiles.forEach((t,i)=>{
      const d=document.createElement('div');
      d.className='tile'; d.textContent=t.text;
      d.addEventListener('click',()=>onTile(i));
      boardEl.appendChild(d);
      t.el=d;
    });
  }

  function onTile(i){
    const t=tiles[i]; if(t.matched) return;
    if(selected.includes(i)) return;
    t.el.classList.add('selected');
    selected.push(i);
    if(selected.length===2){ checkMatch(); }
  }

  function checkMatch(){
    const [a,b]=selected;
    const A=tiles[a], B=tiles[b];
    if(A.val===B.val && A.typ!==B.typ){
      A.matched=B.matched=true;
      setTimeout(()=>{ A.el.classList.add('matched'); A.el.textContent=''; B.el.classList.add('matched'); B.el.textContent=''; selected=[]; },200);
    } else {
      A.el.classList.add('incorrect'); B.el.classList.add('incorrect');
      setTimeout(()=>{ A.el.classList.remove('selected','incorrect'); B.el.classList.remove('selected','incorrect'); selected=[]; },500);
    }
  }

  applyPicBtn.addEventListener('click',()=>{
    const url=picURLInput.value.trim();
    if(!url){bgEl.style.backgroundImage='';return;}
    const img=new Image();
    img.onload=()=>{bgEl.style.backgroundImage=`url('${url}')`;bgEl.style.backgroundColor='';};
    img.onerror=()=>alert('Image failed to load.');
    img.src=url;
  });

  function loadFromURL(){
    const params = new URLSearchParams(window.location.search);
    const leftParam = params.get('left');
    const rightParam = params.get('right');
    const imageParam = params.get('image');
    if(leftParam){ leftTables = new Set(leftParam.split(',').map(Number)); }
    if(rightParam){ rightTables = new Set(rightParam.split(',').map(Number)); }
    if(imageParam){ bgEl.style.backgroundImage = `url('${imageParam}')`; }
  }

  generateLinkBtn.addEventListener('click',()=>{
    const leftArr = Array.from(leftTables).join(',');
    const rightArr = Array.from(rightTables).join(',');
    const img = encodeURIComponent(picURLInput.value.trim());
    const link = `${window.location.origin}${window.location.pathname}?left=${leftArr}&right=${rightArr}&image=${img}`;
    generatedLinkInput.value = link;
  });

  makeTableButtons(leftRoot,leftTables);
  makeTableButtons(rightRoot,rightTables);

  loadFromURL();
  buildBoard();
})();
</script>
